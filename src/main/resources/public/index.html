<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rivers & Roses Command Center</title>
    <style>
      :root {
        --bg-color: #0b0d12;
        --panel-bg: #161b22;
        --border-color: #30363d;
        --text-primary: #c9d1d9;
        --text-secondary: #8b949e;
        --accent-color: #58a6ff;
        --accent-hover: #79c0ff;
        --danger-color: #f85149;
        --success-color: #3fb950;
      }
      body {
        margin: 0;
        background-color: var(--bg-color);
        color: var(--text-primary);
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial,
          sans-serif;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      #app-container {
        display: flex;
        flex: 1;
        height: 100%;
        overflow: hidden;
      }
      #game-view {
        flex: 1;
        position: relative;
        background: #010409;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #sidebar {
        width: 350px;
        flex-shrink: 0;
        background: var(--panel-bg);
        border-left: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        z-index: 10;
        box-shadow: -5px 0 15px rgba(0, 0, 0, 0.5);
      }
      canvas {
        background-color: #0d1117;
        border: 1px solid var(--border-color);
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
      }
      #login-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(13, 17, 23, 0.95);
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
      }
      .login-box {
        background: var(--panel-bg);
        border: 1px solid var(--border-color);
        padding: 2rem;
        border-radius: 8px;
        width: 400px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      }
      .login-tabs {
        display: flex;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
      }
      .tab-btn {
        flex: 1;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        padding: 10px;
        cursor: pointer;
        font-weight: 600;
        border-bottom: 2px solid transparent;
      }
      .tab-btn.active {
        color: var(--accent-color);
        border-bottom-color: var(--accent-color);
      }
      .form-group {
        margin-bottom: 1rem;
      }
      label {
        display: block;
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 4px;
      }
      input[type="text"],
      input[type="number"] {
        width: 100%;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        box-sizing: border-box;
        font-family: monospace;
      }
      input:focus {
        border-color: var(--accent-color);
        outline: none;
      }
      .btn {
        display: block;
        width: 100%;
        padding: 8px 16px;
        background: #21262d;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-primary);
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        text-align: center;
      }
      .btn:hover {
        background: var(--border-color);
      }
      .btn-primary {
        background: var(--accent-color);
        color: white;
        border: none;
      }
      .btn-primary:hover {
        background: var(--accent-hover);
      }
      .card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 15px;
      }
      h2 {
        font-size: 12px;
        color: var(--text-secondary);
        margin: 0 0 8px 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .scroll-y {
        overflow-y: auto;
        flex: 1;
        padding: 1rem;
      }
      .ship-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .ship-item {
        padding: 8px;
        border: 1px solid var(--border-color);
        margin-bottom: 6px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
      }
      .ship-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }
      .ship-item.active {
        border-color: var(--accent-color);
        background: rgba(88, 166, 255, 0.1);
      }
      .lb-rank {
        width: 20px;
        font-weight: bold;
        color: var(--text-secondary);
      }
      .lb-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .lb-score {
        color: #e3b341;
        font-family: monospace;
      }
      #toast {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--accent-color);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 200;
        pointer-events: none;
      }
      #log-panel {
        height: 180px;
        background: #0d1117;
        border-top: 1px solid var(--border-color);
        padding: 10px;
        font-size: 11px;
        overflow-y: auto;
        font-family: monospace;
      }
      .log-line {
        margin-bottom: 4px;
        color: var(--text-secondary);
        border-bottom: 1px solid #1c2128;
        padding-bottom: 2px;
      }
      .log-err {
        color: var(--danger-color);
      }
      .log-success {
        color: var(--success-color);
      }
      .hidden {
        display: none !important;
      }
      .flex-row {
        display: flex;
        gap: 8px;
      }
      .text-xs {
        font-size: 10px;
      }
    </style>
  </head>
  <body>
    <div id="login-overlay">
      <div class="login-box">
        <div class="login-tabs">
          <button class="tab-btn active" onclick="switchTab('login', event)">
            Login
          </button>
          <button class="tab-btn" onclick="switchTab('register', event)">
            Register Team
          </button>
        </div>
        <div id="tab-login">
          <div class="form-group">
            <label>Access Token</label>
            <input type="text" id="login-token" placeholder="cmd-xxxxxxxxx" />
          </div>
          <button class="btn btn-primary" onclick="app.login()">
            Connect to Fleet
          </button>
        </div>
        <div id="tab-register" class="hidden">
          <div class="form-group">
            <label>Token (Optional)</label>
            <input
              type="text"
              id="reg-token"
              placeholder="Leave empty to generate"
            />
          </div>
          <div class="form-group">
            <label>Team Name</label>
            <input type="text" id="reg-team" placeholder="e.g. Red Squadron" />
          </div>
          <div class="form-group">
            <label>Home Planet Name</label>
            <input type="text" id="reg-planet" placeholder="e.g. Mars Base" />
          </div>
          <button class="btn btn-primary" onclick="app.registerTeam()">
            Initialize Account
          </button>
        </div>
      </div>
    </div>
    <div id="app-container">
      <div id="game-view">
        <div id="toast">Command Sent</div>
        <canvas id="worldCanvas"></canvas>
        <div
          style="
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            pointer-events: none;
          "
        >
          L-Click: Select Point • R-Click: Move Ship • Wheel: Zoom
        </div>
      </div>
      <div id="sidebar">
        <div class="scroll-y">
          <div class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div>
                <div style="font-size: 10px; color: #8b949e">COMMANDER</div>
                <div
                  style="font-size: 14px; font-weight: bold; color: #fff"
                  id="hud-team-name"
                >
                  Unknown
                </div>
              </div>
              <div style="text-align: right">
                <div style="font-size: 10px; color: #8b949e">CREDITS</div>
                <div
                  style="
                    color: #e3b341;
                    font-family: monospace;
                    font-size: 14px;
                  "
                  id="hud-credits"
                >
                  0
                </div>
              </div>
            </div>
            <div
              style="
                margin-top: 10px;
                border-top: 1px solid #30363d;
                padding-top: 8px;
              "
            >
              <label>Auth Token</label>
              <div class="flex-row">
                <input
                  type="text"
                  id="hud-token"
                  readonly
                  style="font-size: 10px; padding: 4px"
                />
                <button
                  class="btn"
                  style="width: auto; padding: 4px 8px; font-size: 10px"
                  onclick="app.copyToken()"
                >
                  Copy
                </button>
              </div>
            </div>
          </div>
          <div class="card">
            <h2>Shipyard</h2>
            <div class="flex-row">
              <input
                type="text"
                id="new-ship-name"
                placeholder="New Ship Name"
              />
              <button
                class="btn btn-primary"
                style="width: auto"
                onclick="app.constructShip()"
              >
                Build
              </button>
            </div>
          </div>
          <div class="card">
            <h2>Fleet</h2>
            <div id="fleet-list-container">
              <p style="font-size: 11px; color: #666; font-style: italic">
                No ships under command.
              </p>
            </div>
          </div>
          <div class="card">
            <h2>Long Range Scanners</h2>
            <div class="flex-row">
              <button class="btn" style="width: auto" onclick="app.scan()">
                Scan
              </button>
            </div>
          </div>
          <div class="card">
            <h2>Sector Leaderboard</h2>
            <ul id="leaderboard" class="ship-list"></ul>
          </div>
        </div>
        <div id="log-panel">
          <div class="log-line">> System initialized...</div>
        </div>
      </div>
    </div>
    <script>
      const $ = (id) => document.getElementById(id);

      const log = (msg, type = "normal") => {
        const div = document.createElement("div");
        const time = new Date().toLocaleTimeString([], { hour12: false });
        div.className = `log-line ${type === "error" ? "log-err" : type === "success" ? "log-success" : ""}`;
        div.innerText = `[${time}] ${msg}`;
        const p = $("log-panel");
        p.prepend(div);
      };

      function getOreColor(oreId) {
        if (!oreId) {
          return "#a371f7";
        }
        const id = String(oreId).toLowerCase();

        if (id.includes("iron")) {
          return "#b0b0b0";
        }
        if (id.includes("diamond")) {
          return "#4fd1ff";
        }
        if (id.includes("gold")) {
          return "#e3b341";
        }

        return "#a371f7";
      }

      const state = {
        token: localStorage.getItem("rr_token") || "",
        team: null,
        myShips: [],
        selectedShipId: null,
        world: {
          width: 1000,
          height: 1000,
          homeX: 500,
          homeY: 500,
          ships: [],
          resources: [],
          missions: [],
          stations: [],
        },
        renderShips: new Map(),
        knownResources: new Map(),
      };

      const api = {
        async post(url, body, options = {}) {
          const res = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Token": state.token,
            },
            body: JSON.stringify(body),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.message || res.statusText);
          }
          if (options.noBody) {
            return;
          }
          return res.json();
        },
        async get(url) {
          const res = await fetch(url, { headers: { "X-Token": state.token } });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.message || res.statusText);
          }
          return res.json();
        },
      };

      const app = {
        init() {
          if (state.token) $("login-token").value = state.token;
          renderer.init();
          requestAnimationFrame(loopRender);
          setInterval(app.fetchLeaderboard, 3000);
          setInterval(app.refreshMyShips, 3000);
          wsClient.connect();
        },

        async login() {
          const token = $("login-token").value.trim();
          if (!token) {
            log("Token required", "error");
            return;
          }
          state.token = token;
          try {
            const ships = await api.get("/ships/me");
            localStorage.setItem("rr_token", state.token);
            state.myShips = ships;
            if (ships.length > 0) {
              state.team = ships[0].teamName;
              state.selectedShipId = ships[0].shipId;
            } else {
              state.team = "Commander";
            }
            ui.hideLogin();
            ui.updateHud();
            ui.renderFleet();
            log("Login successful.", "success");
          } catch (e) {
            log(`Login failed: ${e.message}`, "error");
          }
        },

        async registerTeam() {
          const token =
            $("reg-token").value.trim() ||
            "cmd-" + Math.random().toString(36).substr(2, 9);
          const team = $("reg-team").value.trim() || "Anon";
          const planet = $("reg-planet").value.trim() || `${team} Prime`;
          try {
            const res = await fetch("/ships/teams/register", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                token,
                teamName: team,
                planetName: planet,
              }),
            });
            if (!res.ok) {
              const err = await res.json().catch(() => ({}));
              throw new Error(err.message || "Registration failed");
            }
            state.token = token;
            state.team = team;
            state.myShips = [];
            localStorage.setItem("rr_token", token);
            log("Team registered! Construct your first ship.", "success");
            ui.hideLogin();
            ui.updateHud();
            ui.renderFleet();
          } catch (e) {
            log(`Registration error: ${e.message}`, "error");
          }
        },

        async constructShip() {
          const name = $("new-ship-name").value.trim();
          if (!name) {
            log("Ship name required", "error");
            return;
          }
          try {
            const res = await api.post("/ships/register", { shipName: name });
            state.myShips.push(res);
            if (!state.selectedShipId) state.selectedShipId = res.shipId;
            ui.renderFleet();
            $("new-ship-name").value = "";
            log(`Constructed: ${name}`, "success");
          } catch (e) {
            log(`Build failed: ${e.message}`, "error");
          }
        },

        async setCourse(x, y) {
          if (!state.selectedShipId) {
            log("Select a ship from Fleet first", "error");
            return;
          }
          try {
            await api.post(
              "/ships/course",
              { shipId: state.selectedShipId, targetX: x, targetY: y },
              { noBody: true },
            );
            ui.toast("Coordinates Sent");
            renderer.targetReticle = { x, y, time: Date.now() };
          } catch (e) {
            log(`Navigation error: ${e.message}`, "error");
          }
        },

        async scan() {
          try {
            ui.toast("Scanning...");

            const shipId = state.selectedShipId;
            const query = shipId ? `?shipId=${shipId}` : "";

            const res = await api.get(`/scan${query}`);

            const ships = Array.isArray(res.ships) ? res.ships : [];
            const resources = Array.isArray(res.resources) ? res.resources : [];

            log(
              `Scan complete: ${ships.length} ships, ${resources.length} resources found.`,
              "success",
            );

            resources.forEach((resItem) => {
              state.knownResources.set(resItem.id, resItem);
            });

            app.refreshMyShips();
          } catch (e) {
            log(`Scan failed: ${e.message}`, "error");
          }
        },

        async fetchLeaderboard() {
          try {
            const url = `/leaderboard?ts=${Date.now()}`;
            const res = await fetch(url, {
              headers: { "Cache-Control": "no-cache" },
            }).then((r) => r.json());
            ui.renderLeaderboard(res);
          } catch (e) {}
        },

        async refreshMyShips() {
          if (!state.token) return;
          try {
            const ships = await api.get("/ships/me");
            state.myShips = ships;
            if (!ships.some((s) => s.shipId === state.selectedShipId)) {
              state.selectedShipId = ships.length > 0 ? ships[0].shipId : null;
            }
            ui.updateHud();
            ui.renderFleet();
          } catch (e) {}
        },

        copyToken() {
          if (!state.token) return;
          navigator.clipboard.writeText(state.token).catch(() => {});
          ui.toast("Token Copied");
        },
      };

      const ui = {
        hideLogin() {
          $("login-overlay").style.display = "none";
        },

        updateHud() {
          $("hud-team-name").innerText = state.team || "Unknown";
          $("hud-token").value = state.token || "";
          if (state.myShips.length > 0) {
            $("hud-credits").innerText = (
              state.myShips[0].teamCredits || 0
            ).toLocaleString();
          }
        },

        renderFleet() {
          const list = $("fleet-list-container");
          list.innerHTML = "";
          if (state.myShips.length === 0) {
            list.innerHTML =
              '<p style="font-size:11px; color:#666; font-style:italic;">No ships.</p>';
            return;
          }
          const ul = document.createElement("ul");
          ul.className = "ship-list";
          state.myShips.forEach((s) => {
            const live = state.renderShips.get(s.shipId) || s;
            const li = document.createElement("li");
            li.className = `ship-item ${s.shipId === state.selectedShipId ? "active" : ""}`;
            li.onclick = () => {
              state.selectedShipId = s.shipId;
              ui.renderFleet();
            };
            const nameLabel =
              live.displayName || s.displayName || s.teamName || "Ship";
            const posX = Math.round(live.x || 0);
            const posY = Math.round(live.y || 0);
            li.innerHTML = `
              <div>
                  <div style="font-weight:bold; font-size:12px; color:#e6edf3;">${nameLabel}</div>
                  <div style="font-size:10px; color:#8b949e; font-family:monospace;">
                      POS: ${posX},${posY}
                  </div>
              </div>
              <div style="text-align:right;">
                  <div style="font-size:10px; color:${s.shipId === state.selectedShipId ? "#58a6ff" : "#30363d"}">CMD</div>
              </div>
            `;
            ul.appendChild(li);
          });
          list.appendChild(ul);
        },

        renderLeaderboard(data) {
          const el = $("leaderboard");
          el.innerHTML = data
            .map(
              (t, idx) => `
            <li class="ship-item" style="padding:4px 8px; cursor:default; border:none; border-bottom:1px solid #21262d;">
              <span class="lb-rank">#${idx + 1}</span>
              <span class="lb-name">${t.team}</span>
              <span class="lb-score">${t.score}</span>
            </li>
          `,
            )
            .join("");
        },

        toast(msg) {
          const t = $("toast");
          t.innerText = msg;
          t.style.opacity = 1;
          setTimeout(() => (t.style.opacity = 0), 2000);
        },
      };

      const wsClient = {
        socket: null,

        connect() {
          const proto = location.protocol === "https:" ? "wss" : "ws";
          const url = `${proto}://${location.host}/ws/world`;
          this.socket = new WebSocket(url);

          this.socket.onopen = () => {
            log("Uplink established.", "success");
          };

          this.socket.onclose = () => {
            setTimeout(() => this.connect(), 2000);
          };

          this.socket.onmessage = (e) => {
            let msg;
            try {
              msg = JSON.parse(e.data);
            } catch {
              return;
            }
            if (msg.type === "snapshot") {
              state.world = msg.payload;
              renderer.resize();
              this.syncRenderState(state.world.ships || []);
            }
            if (msg.type === "delta") {
              const ops = (msg.payload && msg.payload.ops) || [];
              ops.forEach((op) => {
                if (op.ship) {
                  upsert(state.world.ships, op.ship, "shipId");
                  this.updateShipRender(op.ship);
                }
                if (op.resource) {
                  state.knownResources.set(op.resource.id, op.resource);
                }
                if (op.id && !op.ship && !op.resource) {
                  state.knownResources.delete(op.id);
                }
              });
            }
          };
        },

        updateShipRender(serverShip) {
          const now = Date.now();
          const existing = state.renderShips.get(serverShip.shipId);
          if (!existing) {
            state.renderShips.set(serverShip.shipId, {
              ...serverShip,
              serverX: serverShip.x,
              serverY: serverShip.y,
              lastUpdate: now,
            });
            return;
          }
          const dx = serverShip.x - existing.x;
          const dy = serverShip.y - existing.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist > 100) {
            existing.x = serverShip.x;
            existing.y = serverShip.y;
          }
          existing.serverX = serverShip.x;
          existing.serverY = serverShip.y;
          existing.speed = serverShip.speed;
          existing.headingDeg = serverShip.headingDeg;
          existing.lastUpdate = now;
          existing.teamName = serverShip.teamName;
          existing.displayName = serverShip.displayName || existing.displayName;
        },

        syncRenderState(serverShips) {
          (serverShips || []).forEach((s) => this.updateShipRender(s));
        },
      };

      function upsert(arr, item, key) {
        if (!arr) return;
        const idx = arr.findIndex((x) => x[key] === item[key]);
        if (idx > -1) arr[idx] = item;
        else arr.push(item);
      }

      const renderer = {
        canvas: $("worldCanvas"),
        ctx: null,
        scale: 1,
        targetReticle: null,

        init() {
          this.ctx = this.canvas.getContext("2d");
          window.addEventListener("resize", () => this.resize());
          this.resize();

          this.canvas.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            const r = this.canvas.getBoundingClientRect();
            const x = (e.clientX - r.left) / this.scale;
            const y = (e.clientY - r.top) / this.scale;
            app.setCourse(x, y);
          });

          this.canvas.addEventListener("mousedown", (e) => {
            if (e.button !== 0) return;
            const r = this.canvas.getBoundingClientRect();
            const x = (e.clientX - r.left) / this.scale;
            const y = (e.clientY - r.top) / this.scale;
            let clickedId = null;
            for (const [id, s] of state.renderShips) {
              const dist = Math.hypot(s.x - x, s.y - y);
              if (dist < 15) {
                clickedId = id;
                break;
              }
            }
            if (
              clickedId &&
              state.myShips.some((m) => m.shipId === clickedId)
            ) {
              state.selectedShipId = clickedId;
              ui.renderFleet();
            }
          });
        },

        resize() {
          const container = $("game-view");
          const w = container.clientWidth;
          const h = container.clientHeight;
          const size = Math.min(w, h) - 20;
          this.canvas.width = size;
          this.canvas.height = size;
          this.scale = size / (state.world.width || 1000);
        },

        draw() {
          const ctx = this.ctx;
          const w = this.canvas.width;
          const h = this.canvas.height;
          const now = Date.now();

          ctx.fillStyle = "#010409";
          ctx.fillRect(0, 0, w, h);

          ctx.strokeStyle = "#161b22";
          ctx.lineWidth = 1;
          const step = 100 * this.scale;
          ctx.beginPath();
          for (let i = 0; i <= w; i += step) {
            ctx.moveTo(i, 0);
            ctx.lineTo(i, h);
          }
          for (let i = 0; i <= h; i += step) {
            ctx.moveTo(0, i);
            ctx.lineTo(w, i);
          }
          ctx.stroke();

          state.renderShips.forEach((ship) => {
            const age = (now - ship.lastUpdate) / 1000;
            if (age < 2.0 && ship.speed > 0) {
              const rad = (ship.headingDeg * Math.PI) / 180;
              const projectedX =
                ship.serverX + Math.sin(rad) * ship.speed * age;
              const projectedY =
                ship.serverY - Math.cos(rad) * ship.speed * age;
              const alpha = 0.1;
              ship.x = ship.x + (projectedX - ship.x) * alpha;
              ship.y = ship.y + (projectedY - ship.y) * alpha;
            } else {
              const alpha = 0.1;
              ship.x = ship.x + (ship.serverX - ship.x) * alpha;
              ship.y = ship.y + (ship.serverY - ship.y) * alpha;
            }
          });

          const homeX = (state.world.homeX || 500) * this.scale;
          const homeY = (state.world.homeY || 500) * this.scale;
          ctx.strokeStyle = "#238636";
          ctx.beginPath();
          ctx.arc(homeX, homeY, 40 * this.scale, 0, Math.PI * 2);
          ctx.stroke();
          ctx.fillStyle = "#238636";
          ctx.font = "10px monospace";
          ctx.fillText("BASE", homeX - 10, homeY + 4);

          ctx.fillStyle = "#8b949e";
          (state.world.stations || []).forEach((s) => {
            const sx = s.x * this.scale;
            const sy = s.y * this.scale;
            ctx.fillRect(sx - 4, sy - 4, 8, 8);
            ctx.fillStyle = "#fff";
            ctx.font = "10px sans-serif";
            ctx.fillText(
              s.name,
              sx - ctx.measureText(s.name).width / 2,
              sy - 8,
            );
            ctx.fillStyle = "#8b949e";
          });

          const allResources = [
            ...(state.world.resources || []),
            ...state.knownResources.values(),
          ];
          allResources.forEach((r) => {
            const rx = r.x * this.scale;
            const ry = r.y * this.scale;
            const color = getOreColor(r.oreId || r.id);
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(rx, ry, 3, 0, Math.PI * 2);
            ctx.fill();
          });
          state.renderShips.forEach((s) => {
            const x = s.x * this.scale;
            const y = s.y * this.scale;
            const isMine = state.myShips.some((my) => my.shipId === s.shipId);
            const isSelected = state.selectedShipId === s.shipId;

            ctx.save();
            ctx.translate(x, y);

            if (isSelected) {
              ctx.strokeStyle = "#fff";
              ctx.lineWidth = 1;
              ctx.beginPath();
              ctx.arc(0, 0, 14, 0, Math.PI * 2);
              ctx.stroke();
            }

            ctx.rotate((s.headingDeg * Math.PI) / 180);
            ctx.fillStyle = isMine ? "#58a6ff" : "#30363d";
            ctx.beginPath();
            ctx.moveTo(0, -7);
            ctx.lineTo(6, 6);
            ctx.lineTo(0, 4);
            ctx.lineTo(-6, 6);
            ctx.fill();
            ctx.restore();

            ctx.fillStyle = isMine ? "#58a6ff" : "#8b949e";
            ctx.font = "10px sans-serif";
            const label = s.displayName || s.teamName || "Unknown";
            ctx.fillText(label, x - ctx.measureText(label).width / 2, y + 28);
          });

          if (this.targetReticle) {
            const age = now - this.targetReticle.time;
            if (age < 1000) {
              const x = this.targetReticle.x * this.scale;
              const y = this.targetReticle.y * this.scale;
              const size = 20 - age / 50;
              ctx.strokeStyle = `rgba(88, 166, 255, ${1 - age / 1000})`;
              ctx.beginPath();
              ctx.moveTo(x - size, y);
              ctx.lineTo(x + size, y);
              ctx.moveTo(x, y - size);
              ctx.lineTo(x, y + size);
              ctx.stroke();
            } else {
              this.targetReticle = null;
            }
          }
        },
      };

      function loopRender() {
        renderer.draw();
        requestAnimationFrame(loopRender);
      }

      window.switchTab = (tab, ev) => {
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        if (ev && ev.target) {
          ev.target.classList.add("active");
        }
        $("tab-login").classList.add("hidden");
        $("tab-register").classList.add("hidden");
        $("tab-" + tab).classList.remove("hidden");
      };

      $("worldCanvas").oncontextmenu = () => false;

      app.init();
    </script>
  </body>
</html>
